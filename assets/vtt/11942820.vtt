WEBVTT

00:02.470 --> 00:08.300
So we're making progress on the add to cart functionality, at least a very basic first version of it,

00:08.620 --> 00:14.740
let's now go to app.js to wire it up. When finding a user, I'm storing it in the request like this and

00:14.830 --> 00:17.210
this actually should be

00:17.410 --> 00:18.950
all right,

00:18.970 --> 00:24.490
however it's important to understand that the user as I'm storing it here will just be an object with

00:24.490 --> 00:25.370
the properties,

00:25.390 --> 00:31.150
so the data we have in the database. All the methods of our user model will not be in there because the

00:31.150 --> 00:35.590
user I'm getting here is data I'm getting out of the database and the methods aren't stored there,

00:35.590 --> 00:37.370
they couldn't be stored there.

00:37.420 --> 00:45.940
So to have a real user object with which we can interact, I should actually create a new user here

00:47.060 --> 00:58.170
and then simply pass user.name which is my username, how it's a stored, user email, user cart and

00:58.170 --> 00:59.990
user_id,

01:00.000 --> 01:05.970
so I should create such a user object and store that in the request because now this enables me to really

01:06.090 --> 01:07.270
work with

01:07.440 --> 01:13.740
well all the user data or with the whole user model and this now allows me to also call all these methods

01:13.740 --> 01:16.020
like add to cart on it.

01:16.020 --> 01:23.140
So with this changed to app.js, we can go to the shop.js file in the controllers folder and then there,

01:23.280 --> 01:30.720
I want to work on the post cart method for now which allows me to add an element to the cart.

01:31.230 --> 01:33.630
I do get my product id here which is nice

01:33.780 --> 01:39.810
and then we have all the logic here for fetching what's inside the cart and for updating this,

01:40.050 --> 01:44.720
I will actually comment this out because for now we don't need that.

01:44.730 --> 01:49.250
So instead what I want to do is here I want to fetch the product I want to add here,

01:49.470 --> 01:57.370
so I will use my product constructor, my product model and I will use find by ID to find a product by

01:57.480 --> 02:05.680
the product ID I'm extracting here and I'll just add the then block here and in here, I should have the product that

02:05.680 --> 02:07.920
I want to add to the cart.

02:08.230 --> 02:15.460
Therefore in here, I will now use request user which now is our full user model and call add to cart

02:15.880 --> 02:22.690
and pass that product I fetched as an argument because in the user model, add to cart does expect

02:22.690 --> 02:27.450
a product and then I return the result of update one which will be a promise,

02:27.550 --> 02:33.890
so back in the shop.js controller, if I return that promise instead of then here, I can simply chain

02:33.980 --> 02:34.750
another then

02:34.760 --> 02:39.330
block where I get the result of in this case my update operation,

02:39.400 --> 02:43.110
so I'll just console log that result.

02:43.150 --> 02:51.090
Now with that, let me go to the shop.js routes and let me add that cart post route again.

02:51.370 --> 02:59.230
Let's now go back to products and let's give this add to cart button a try and I get an error here.

03:00.330 --> 03:08.260
The problem here should be that if we have a look at our view, at our product list.ejs file, that for

03:08.260 --> 03:15.910
add to cart, we have that add to cart ejs snippet that include where I pass my product to but

03:15.910 --> 03:20.940
in add to cart ejs, I still access product.id instead of _id,

03:21.160 --> 03:27.910
so I need to change this in order to pass on the ID correctly. So now if I reload that products page and

03:27.910 --> 03:30.200
I click add to cart,

03:30.240 --> 03:38.880
now we get stuck here but actually we were successful in a way. We did actually modify something as our

03:38.880 --> 03:44.130
result tells us here and if we quickly go to compass and have a look at our users, you see there is

03:44.190 --> 03:52.050
an embedded document, a cart document with items with an object which holds product data.

03:52.050 --> 03:57.570
Now that user ID here is a bit redundant because were already are in that user, we could strip that out

03:57.570 --> 04:01.270
and only store what we want but it also that doesn't matter too much.

04:01.410 --> 04:07.830
The important thing for us here simply is that we now store a whole product which we do also store in

04:07.830 --> 04:12.590
a separate collection as part of an embedded document in our user,

04:12.630 --> 04:14.910
so we clearly have duplicate data here,

04:14.970 --> 04:20.310
we have the same product here as an embedded document and we have it in products.

04:20.340 --> 04:24.840
So this is maybe something which we should change because if we change the product right now, if we

04:24.840 --> 04:30.170
change the title or the price, this will not be reflected in the cart and in the cart

04:30.180 --> 04:36.680
we should have correct data because if the price changes, we can show the wrong price in our cart,

04:36.720 --> 04:37.480
right.

04:37.530 --> 04:45.840
So actually we'll need to tweak this a little bit more. In our user model where I store product in add

04:45.840 --> 04:48.990
to cart, well

04:49.260 --> 04:53.580
I actually don't want to store all product data in this object

04:53.580 --> 04:54.920
and then the quantity,

04:55.230 --> 05:06.670
I just want to store the product ID by creating a new objectid here and passing product.ID, 

05:06.670 --> 05:09.090
._id as an argument and the quantity,

05:09.100 --> 05:13.590
so now only the reference and the quantity and not the rest of the data.

05:13.790 --> 05:19.320
If I now save this and I click add to cart again,

05:19.330 --> 05:20.360
it gets stuck again, it

05:20.380 --> 05:22.340
doesn't matter too much right now.

05:22.390 --> 05:24.970
If I now update my users,

05:28.010 --> 05:34.200
I get an error here, that should be Product_id, product_id, I forgot the t.

05:34.460 --> 05:44.810
So now again if I update this and I click add to cart again and I reload my users document here or

05:44.810 --> 05:46.160
my collection,

05:46.160 --> 05:51.190
now you see I'm only storing the reference and the quantity and this is exactly the information I want.

05:51.200 --> 05:56.840
If I now want to display information about the product, I have to fetch that manually because I only

05:56.840 --> 06:01.170
have the ID, that on the other hand is all I need for fetching information,

06:01.190 --> 06:02.380
so that is what it is.

06:02.390 --> 06:07.310
But on the other hand if I now do change my product, I don't have to change it in the products collection

06:07.460 --> 06:12.820
and my users because that would be a lot of work for data that might change quite a lot.
