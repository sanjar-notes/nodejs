WEBVTT

00:02.240 --> 00:03.920
Now in this module we covered a lot

00:03.920 --> 00:05.510
and we work with files a lot.

00:05.510 --> 00:11.870
Now one thing you might notice is that whenever we for example change an image or when we delete a product,

00:12.130 --> 00:17.360
the file belonging to that product, the image belonging to the product sticks around.

00:17.360 --> 00:22.790
Now obviously you can always delete files with the file system package,

00:22.910 --> 00:25.700
there you also got options for deleting files.

00:25.970 --> 00:33.470
You could delete files whenever you added a product when you override the image,

00:33.470 --> 00:37.630
so here if you are inside that if block and we set a new image url,

00:37.640 --> 00:43.340
then we could also kick off a function that goes ahead and deletes the old image by fetching that

00:43.430 --> 00:48.050
from the product first because we're fetching the product here, so we can get access to the old image

00:48.050 --> 00:54.020
path by fetching that path and then using the file system to delete that old image and we can of course

00:54.020 --> 00:57.590
also delete an image when we delete the product.

00:57.830 --> 01:06.350
So let's add this functionality as a last step now and for that, I will go to my util folder

01:10.500 --> 01:16.180
and add a file, js file where I will add some helper functionality.

01:16.190 --> 01:23.090
There I'll import the file system, so the file system is imported here and I'll have a constant which

01:23.090 --> 01:32.270
holds a function which I'll name delete file. This function should accept the file path and that's it

01:32.280 --> 01:39.320
let's say. In here I can use the file system package and there,

01:39.360 --> 01:45.690
you'll have the unlink method, it deletes the name and the file that is connected to the name, so it deletes

01:45.750 --> 01:47.060
a file at this path.

01:47.220 --> 01:56.640
So here I pass file path and then this has the callback we know with an error if it fails and in here,

01:56.640 --> 01:58.860
we can simply check if we got an error and

01:58.860 --> 02:04.920
then I want to throw it again and then it should bubble up in our default express error handler should

02:04.920 --> 02:06.090
be able to take over

02:06.310 --> 02:08.200
otherwise I'll not do anything here.

02:08.280 --> 02:09.680
So it's like a method

02:09.690 --> 02:13.660
I can always call to pass in a file path and delete that file.

02:14.010 --> 02:16.820
And now we can use that in our admin controller,

02:17.970 --> 02:30.860
so let me import my file helper here by requiring it from the util folder and there the file, file and

02:30.880 --> 02:32.410
now I can use that file helper

02:32.490 --> 02:40.780
for example in the place where we added a product. If we are in this if block and we know we'll replace

02:40.780 --> 02:41.960
the image url,

02:42.090 --> 02:50.650
then before I do so, I will use file helper and I call my function there, for that

02:50.660 --> 02:52.170
I need to export it though.

02:52.500 --> 02:57.530
So in here I want to export delete file,

02:57.530 --> 03:00.000
this will hold my delete file constant,

03:00.050 --> 03:03.680
so this function and now in the admin.js controller,

03:03.680 --> 03:10.360
here I can call file helper delete file and I pass in product image

03:10.370 --> 03:16.590
url, so that path to that file and now this should fire.

03:16.590 --> 03:18.770
I'm not waiting for this to complete,

03:18.810 --> 03:21.030
I continue with my other operations,

03:21.030 --> 03:24.150
I'm doing this in a fire and forget manner, so

03:24.150 --> 03:27.210
I'm firing this function and I don't care about the result.

03:27.210 --> 03:32.910
If I wanted to, I would have to pass my callback here, so a function which then continues with the rest

03:32.910 --> 03:34.070
in this function here

03:34.200 --> 03:40.140
but I simply fire it like this and I will do the same when we delete a product.

03:40.210 --> 03:51.080
So in there when we do delete it, here I also want to delete the respective image

03:51.220 --> 03:57.000
and for that, I first of all need to fetch my product of course, so I will have find by ID in here,

03:57.950 --> 03:59.710
find it by prod ID

04:00.040 --> 04:09.160
and then here I have then and catch. In catch I can next any error I get and in the then block, I will have

04:09.160 --> 04:11.550
access to my product,

04:11.830 --> 04:16.000
so here I can then execute my file helper.

04:16.340 --> 04:23.030
I should of course also check if product is not set in which case I'll also return next with a new

04:23.960 --> 04:26.400
error product not found

04:28.210 --> 04:34.790
and otherwise I delete that and I should only trigger delete one here after I found this

04:34.870 --> 04:39.370
otherwise we have a race condition where deleting could finish before finding is finished and that would

04:39.370 --> 04:47.980
be bad. So we'll grab that delete one code, move that in here and return it to return the promise returned by

04:47.980 --> 04:51.720
delete one

04:51.950 --> 04:56.270
and then I can actually replace that catch block with my old then and catch block and this will catch

04:56.270 --> 05:03.020
errors in any of the then blocks and it will also make sure that I first find the product and once I

05:03.020 --> 05:04.000
found it,

05:04.270 --> 05:09.150
I delete the image and I simultaneously start deleting the product itself.

05:09.490 --> 05:12.130
Let's save all of that and let's see if that works.

05:12.190 --> 05:24.620
If I go back to admin products here and I delete product one, this is cleared and here I also have one

05:24.700 --> 05:31.530
image less, if I delete the second product, it's only three images, so this works.

05:31.530 --> 05:36.650
The other images are still sticking around because previously when I started deleting products and so

05:36.650 --> 05:40.520
on, I did not have that logic in place but now this works.

05:41.730 --> 05:45.100
Fetching my invoice or generating it on the fly works

05:45.300 --> 05:48.480
and thanks to the fact that we store a snapshot of that in the database,

05:48.480 --> 05:50.670
it even works after the product was deleted

05:50.700 --> 05:52.700
which is of course the way we want it to work and

05:52.710 --> 05:54.810
with that, we have a really nice setup here.
