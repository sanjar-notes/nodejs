WEBVTT

00:02.260 --> 00:05.450
Now how can we improve this serving of the data?

00:05.530 --> 00:13.030
Well first of all, right now this is only available to authenticated users because on my route here, I

00:13.030 --> 00:16.700
have the isAuth middleware but every user could view that,

00:16.810 --> 00:22.100
I don't have to be the user who placed that order. However for that order,

00:22.120 --> 00:24.560
I of course know which user belongs to it,

00:24.580 --> 00:31.810
I have the user id here. So we can add an extra check in our middleware, in our controller action here

00:32.260 --> 00:38.090
to see if for this order, the user is eligible of downloading it.

00:38.090 --> 00:46.520
Now how do we do that? Well we use the order mongoose model, find that order by that ID in the database

00:46.910 --> 00:52.600
and then check if the order user ID is equal to the ID of the currently logged in user.

00:52.940 --> 01:02.400
So here I can check order and then find by ID and I pass in my order ID, I have then and catch here.

01:02.440 --> 01:08.850
Now as you know, in here we can simply next an error to use the default error handling function

01:09.010 --> 01:15.640
and here we'll have our order element though that could be undefined if no order for this ID is found,

01:15.640 --> 01:26.790
so if no order is found, then I will also return next with new error maybe, no order found, whatever

01:26.810 --> 01:28.600
you want, you can handle this differently.

01:28.730 --> 01:34.070
If we do have an order however, I want to check if the order is from that user who's logged in.

01:34.070 --> 01:43.420
So then I can check if order user and then keep in mind, in the user object we have user ID field, so

01:43.420 --> 01:54.570
if that user ID toString, if that is equal to request user_id, so if the currently logged in

01:54.570 --> 02:00.470
user toString, if that is equal I am allowed to access this, if it's not,

02:00.510 --> 02:07.100
so if I'm checking the opposite, if it's not equal then I will return a new error

02:08.230 --> 02:10.790
unauthorized, something like this.

02:13.700 --> 02:19.800
And only if I make it past these two if checks, only in this case I want to read that file

02:22.390 --> 02:23.070
and output it.

02:25.940 --> 02:28.860
So if I now save this and I access this,

02:29.090 --> 02:32.110
it works, if I change the three here to a two,

02:32.410 --> 02:39.080
I get my error because now it's an invalid url and if I copy that original url which was correct

02:39.290 --> 02:44.120
and I do log out and I try to access this whilst I'm logged out,

02:44.120 --> 02:50.920
I have to log in and if I log in with a different user or let me quickly create that user

02:57.080 --> 03:01.530
and I then log in and I now try to access this order,

03:01.580 --> 03:02.720
I also get an error,

03:02.930 --> 03:04.570
I have to be the correct user.

03:04.580 --> 03:08.920
Now of course you could show a different error message but that is always something you can tweak,

03:08.930 --> 03:14.680
I only want to show you how you can protect this and that you have this option of controlling that access.

03:14.720 --> 03:17.130
So here, this all works just fine.
