## Adding User.getCart method (199)
Created Sunday 7 May 2023 at 12:08 pm

Let's add a new method, that will be used by the cart page controller action.
```js
const { getDB, mongoConnect } = require('./util/database.js');
const mongodb = require("mongodb");

class User {
	// existing code
	
	getCart() {
	  const user = req.user;
	  const cart = user.cart;
	  
	  const db = getDB();
	  
	  const productIds = cart.items.map(item => item.productId);
	  
	  const cartWithProducts = productIds.map(async (productId) => {
	     const product = await db
				.collection('products')
				.findOne({ _id: new mongodb.ObjectId(productId) });
				
		return { ...item, product };
	   });
	   
	  return cartWithProducts;
	}
}
```


'n' network calls are made here. this could be rewritten using `.find()`, so only one call is needed:
```js
let cartWithProducts2 = 
	await db.collection('products')
			.find({ _id: { $in: productIds }})
			.toArray();
		
cartWithProducts2 = cartWithProducts2.map((product) => 
	({ 
	    ...product,
	    quantity: 
		  cart.find(item => item.productId === product._id.toString())
			  .quantity 
	})
);

return cartWithProducts2;
```
Note: 
1. Use `toString()` on the `fetchedInstance._id` because even though `._id` feels like a string, it's not strictly of type `string`.
2. MongoDB has the `$in` query operator is quite helpful, especially in `find` (i.e. find many), syntax:
	```js
	const mongodb = require("mongodb");
	const idArr = [42, 6023].map(id => new ObjectId(id));

	const items = await db.collection('something')
	  .find({ _id: { $in: idArr } })
	  .toArray();
	```

## Deleting Cart items (201)
Created Sunday 7 May 2023 at 12:26 pm

Basically, just update the cart. Updating the code (User model, since cart is a part of it):
```js
const { getDB, mongoConnect } = require('./util/database.js');
const mongodb = require("mongodb");

class User {
  // existing code
  
  async deleteItemFromCart(productId) {
	// make sure we don't mutate the existin cart, since the operation may fail

	// .filter is safe
	const updatedCart = this.cart.filter(item => item.productId.toString() !== productId.toString());

	const db = getDB();
	return db
			.collections('users')
			.updateOne(
			  { _id, new mongodb.ObjectId(this.id)},
		      { $set: { cart: updatedCart }}
			);
  }
}
```